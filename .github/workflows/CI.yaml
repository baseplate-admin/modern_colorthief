# This file is autogenerated by maturin v1.10.2
# To update, run
#
#    maturin generate-ci github
#
name: CI

on:
    push:
        branches:
            - main
            - master
        tags:
            - '*'
    pull_request:
    workflow_dispatch:

permissions:
    contents: read

jobs:
    linux:
        runs-on: ${{ matrix.platform.runner }}
        strategy:
            matrix:
                platform:
                    - runner: ubuntu-22.04
                      target: x86_64
                    - runner: ubuntu-22.04
                      target: x86
                    - runner: ubuntu-22.04
                      target: aarch64
                    - runner: ubuntu-22.04
                      target: armv7
                    - runner: ubuntu-22.04
                      target: s390x
                    - runner: ubuntu-22.04
                      target: ppc64le
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: 3.x
            - name: Build wheels
              uses: PyO3/maturin-action@v1
              with:
                  target: ${{ matrix.platform.target }}
                  args: --release --out dist --find-interpreter
                  sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
                  manylinux: auto
            - name: Upload wheels
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-linux-${{ matrix.platform.target }}
                  path: dist

    musllinux:
        runs-on: ${{ matrix.platform.runner }}
        strategy:
            matrix:
                platform:
                    - runner: ubuntu-22.04
                      target: x86_64
                    - runner: ubuntu-22.04
                      target: x86
                    - runner: ubuntu-22.04
                      target: aarch64
                    - runner: ubuntu-22.04
                      target: armv7
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: 3.x
            - name: Build wheels
              uses: PyO3/maturin-action@v1
              with:
                  target: ${{ matrix.platform.target }}
                  args: --release --out dist --find-interpreter
                  sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
                  manylinux: musllinux_1_2
            - name: Upload wheels
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-musllinux-${{ matrix.platform.target }}
                  path: dist

    windows:
        runs-on: ${{ matrix.platform.runner }}
        strategy:
            matrix:
                platform:
                    - runner: windows-latest
                      target: x64
                    - runner: windows-latest
                      target: x86
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: 3.x
                  architecture: ${{ matrix.platform.target }}
            - name: Build wheels
              uses: PyO3/maturin-action@v1
              with:
                  target: ${{ matrix.platform.target }}
                  args: --release --out dist --find-interpreter
                  sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
            - name: Upload wheels
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-windows-${{ matrix.platform.target }}
                  path: dist

    macos:
        runs-on: ${{ matrix.platform.runner }}
        strategy:
            matrix:
                platform:
                    - runner: macos-15
                      target: x86_64
                    - runner: macos-15
                      target: aarch64
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: 3.x
            - name: Build wheels
              uses: PyO3/maturin-action@v1
              with:
                  target: ${{ matrix.platform.target }}
                  args: --release --out dist --find-interpreter
                  sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
            - name: Upload wheels
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-macos-${{ matrix.platform.target }}
                  path: dist

    sdist:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Build sdist
              uses: PyO3/maturin-action@v1
              with:
                  command: sdist
                  args: --out dist
            - name: Upload sdist
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-sdist
                  path: dist

    release:
        name: Release
        runs-on: ubuntu-latest
        if: ${{ startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch' }}
        needs: [linux, musllinux, windows, macos, sdist]
        permissions:
            # Use to sign the release artifacts
            id-token: write
            # Used to upload release artifacts
            contents: write
            # Used to generate artifact attestation
            attestations: write
        steps:
            - uses: actions/download-artifact@v4
            - name: Generate artifact attestation
              uses: actions/attest-build-provenance@v2
              with:
                  subject-path: 'wheels-*/*'
            - name: Publish to PyPI
              if: ${{ startsWith(github.ref, 'refs/tags/') }}
              uses: PyO3/maturin-action@v1
              env:
                  MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
              with:
                  command: upload
                  args: --non-interactive --skip-existing wheels-*/*

            - name: Upload release artifacts
              if: ${{ startsWith(github.ref, 'refs/tags/') }}
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      wheels-*/*

    aur:
        name: Publish to AUR
        runs-on: ubuntu-latest
        needs: [release]
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        steps:
            - uses: actions/checkout@v4

            - name: Download Linux Wheels
              uses: actions/download-artifact@v4
              with:
                  pattern: wheels-linux*
                  path: dist
                  merge-multiple: true

            - name: Prepare and Publish AUR Packages
              env:
                  AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
                  AUR_USERNAME: ${{ secrets.AUR_USERNAME }}
                  AUR_EMAIL: ${{ secrets.AUR_EMAIL }}
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  python -c "
                  import os
                  import sys
                  import glob
                  import hashlib
                  import re

                  # Get release info
                  ref = os.environ.get('GITHUB_REF', '')
                  version = ref.replace('refs/tags/', '')
                  print(f'Detected version: {version}')

                  repo = os.environ.get('GITHUB_REPOSITORY')

                  # --- HANDLE BIN PACKAGE (WHEEL) ---
                  print('Processing modern-colorthief...')

                  # Find wheel in dist/
                  # We downloaded artifacts to 'dist' dir in previous step
                  dist_dir = 'dist'
                  if not os.path.exists(dist_dir):
                      print(f'Distribution directory {dist_dir} not found!')
                      sys.exit(1)
                      
                  wheels = glob.glob(os.path.join(dist_dir, '*.whl'))
                  print(f'Found wheels: {wheels}')

                  # Filter for manylinux
                  manylinux_wheels = [w for w in wheels if 'manylinux' in w]

                  if not manylinux_wheels:
                      print('No manylinux wheels found! Cannot update bin package.')
                  else:
                      # Sort to find a suitable wheel
                      # We'll just take the first one after reverse sort to align with previous behavior
                      manylinux_wheels.sort(reverse=True)
                      best_wheel_path = manylinux_wheels[0]
                      best_wheel_name = os.path.basename(best_wheel_path)
                      print(f'Selected wheel: {best_wheel_name}')

                      # Calculate SHA256 of local file
                      sha256_hash = hashlib.sha256()
                      with open(best_wheel_path, 'rb') as f:
                          for byte_block in iter(lambda: f.read(4096), b''):
                              sha256_hash.update(byte_block)
                      sha256 = sha256_hash.hexdigest()
                      print(f'SHA256: {sha256}')
                      
                      # Construct download URL for PKGBUILD
                      # https://github.com/<owner>/<repo>/releases/download/<tag>/<filename>
                      download_url = f'https://github.com/{repo}/releases/download/{version}/{best_wheel_name}'
                      print(f'Download URL: {download_url}')

                      # Update PKGBUILD
                      pkgbuild_path = 'aur/modern-colorthief/PKGBUILD'
                      with open(pkgbuild_path, 'r', encoding='utf-8') as f:
                          content = f.read()

                      # Update version, source, checksum
                      content = re.sub(r'^pkgver=.*', f'pkgver={version}', content, flags=re.MULTILINE)
                      content = re.sub(r'^source=\(.*?\)', f'source=(\"{download_url}\")', content, flags=re.MULTILINE)
                      content = re.sub(r'^sha256sums=\(.*?\)', f'sha256sums=(\'{sha256}\')', content, flags=re.MULTILINE)

                      with open(pkgbuild_path, 'w', encoding='utf-8') as f:
                          f.write(content)

                  # --- HANDLE GIT PACKAGE ---
                  print('Processing modern-colorthief-git...')
                  # No explicit changes needed for git package PKGBUILD
                  "

            - name: Deploy -bin package to AUR
              if: success()
              uses: KSXGitHub/github-actions-deploy-aur@v2.7.2
              with:
                  pkgname: modern-colorthief
                  pkgbuild: ./aur/modern-colorthief/PKGBUILD
                  commit_username: ${{ secrets.AUR_USERNAME }}
                  commit_email: ${{ secrets.AUR_EMAIL }}
                  ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
                  commit_message: Update to v${{ github.ref_name }}
                  force_push: true

            - name: Deploy -git package to AUR
              if: success()
              uses: KSXGitHub/github-actions-deploy-aur@v2.7.2
              with:
                  pkgname: modern-colorthief-git
                  pkgbuild: ./aur/modern-colorthief-git/PKGBUILD
                  commit_username: ${{ secrets.AUR_USERNAME }}
                  commit_email: ${{ secrets.AUR_EMAIL }}
                  ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
                  commit_message: Sync with release v${{ github.ref_name }}
                  force_push: true
